services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
      # Enable BuildKit for faster builds and better caching
      args:
        - BUILDKIT_INLINE_CACHE=1
    
    container_name: server_app
    restart: unless-stopped
    
    ports:
      - "5000:5000"
    
    env_file:
      - .env
    
    secrets:
      - firebase_credentials
    
    environment:
      # Firebase Configuration
      - GOOGLE_APPLICATION_CREDENTIALS=/run/secrets/firebase_credentials
      
      # Timezone for scheduled jobs and logs
      - TZ=Asia/Manila
      
      # Node.js Production Optimizations
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=512
      
      # Force production mode for all services
      - NPM_CONFIG_PRODUCTION=true
    
    # ============================================
    # HEALTH CHECK - Critical for Render
    # ============================================
    healthcheck:
      # Enhanced health check with JSON validation
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5000/health || exit 1"]
      interval: 30s          # Check every 30 seconds
      timeout: 10s           # Wait 10s for response
      retries: 3             # Mark unhealthy after 3 failures
      start_period: 60s      # Give 60s for app initialization (MQTT + DB connections)
    
    # ============================================
    # RESOURCE LIMITS - Optimize for Render Free/Starter Tier
    # ============================================
    deploy:
      resources:
        limits:
          cpus: '1.0'        # Max 1 CPU core
          memory: 512M       # Max 512MB RAM (Render free tier)
        reservations:
          cpus: '0.25'       # Reserve at least 0.25 CPU
          memory: 256M       # Reserve at least 256MB RAM
    
    # ============================================
    # VOLUMES - Persistent Logs
    # ============================================
    volumes:
      # Persistent logs across container restarts
      - app_logs:/app/logs
    
    # ============================================
    # LABELS - Metadata & Monitoring
    # ============================================
    labels:
      # App identification
      - "com.capstone.app=water-quality-server"
      - "com.capstone.version=1.0.0"
      - "com.capstone.environment=production"
      
      # Scheduled restart configuration
      - "com.capstone.restart.schedule=saturday-midnight"
      - "com.capstone.restart.timezone=Asia/Manila"
      
      # Service dependencies (for monitoring)
      - "com.capstone.dependencies=mongodb,mqtt,firebase"
      
      # Health monitoring
      - "com.capstone.health.endpoint=/health"
      - "com.capstone.health.critical=true"
    
    # ============================================
    # LOGGING - Rotation to prevent disk overflow
    # ============================================
    logging:
      driver: "json-file"
      options:
        max-size: "10m"      # Rotate after 10MB
        max-file: "3"        # Keep 3 files (30MB total)
        compress: "true"     # Compress rotated logs
    
    # ============================================
    # SECURITY - Container hardening
    # ============================================
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    
    # Drop all capabilities, add only what's needed
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE      # Allow binding to port 5000
    
    # Make root filesystem read-only (except volumes)
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777        # Writable temp (PDF generation)
      - /app/.npm:size=50M,mode=0755    # NPM cache
    
    # ============================================
    # NETWORKING
    # ============================================
    networks:
      - app_network

# ============================================
# VOLUMES DEFINITION
# ============================================
volumes:
  app_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./logs

# ============================================
# NETWORKS DEFINITION
# ============================================
networks:
  app_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ============================================
# SECRETS
# ============================================
secrets:
  firebase_credentials:
    file: ./firebase-service-account.json
